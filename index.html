<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeutschMeister Pro | C1 System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-active:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBRAeIilgqixdDrBQFThpx00D2Te0gPuY0",
            authDomain: "deutschmeister-489ea.firebaseapp.com",
            projectId: "deutschmeister-489ea",
            storageBucket: "deutschmeister-489ea.firebasestorage.app",
            messagingSenderId: "82755973685",
            appId: "1:82755973685:web:3413021c19d391107a777c",
            measurementId: "G-3HD3BYTV1M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' }); // –í—Å–µ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞

        window.API = { 
            auth, db, provider, signInWithPopup, signOut, 
            onAuthStateChanged, signInAnonymously, doc, setDoc, onSnapshot 
        };
    </script>

    <!-- REACT APP -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const PHASES = [
            { id: 0, level: 'A1', name: '–ó–∞–∫–ª–∞–¥–∫–∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞', days: 90, res: 'Nicos Weg A1', tasksA: [{id:'a1_1', title:'Nicos Weg: –ê–Ω–∞–ª–∏–∑', time:20, type:'Input'}, {id:'a1_2', title:'Anki: –ù–æ–≤—ã–µ –∫–∞—Ä—Ç—ã', time:10, type:'Memory'}, {id:'a1_3', title:'V2 Rule: –°–∏–Ω—Ç–∞–∫—Å–∏—Å', time:10, type:'Study'}], tasksB: [{id:'b1_1', title:'Shadowing (NW)', time:15, type:'Output'}, {id:'b1_2', title:'Anki: –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ', time:15, type:'Memory'}, {id:'b1_3', title:'SST: –ú–æ–Ω–æ–ª–æ–≥', time:10, type:'Output'}] },
            { id: 1, level: 'A2', name: '–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∫–∞—Ä–∫–∞—Å–∞', days: 90, res: 'Nicos Weg A2', tasksA: [{id:'a2_1', title:'Perfekt: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞', time:20, type:'Input'}, {id:'a2_2', title:'Dino lernt Deutsch', time:15, type:'Input'}, {id:'a2_3', title:'Anki: –ù–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã', time:5, type:'Memory'}], tasksB: [{id:'b2_1', title:'–°–∏–Ω—Ç–µ–∑: –ú–æ–π –≤—á–µ—Ä–∞', time:20, type:'Output'}, {id:'b2_2', title:'Anki: –°–µ—Ç', time:15, type:'Memory'}, {id:'b2_3', title:'ChatGPT: –ü—Ä–æ–≤–µ—Ä–∫–∞', time:5, type:'Output'}] },
            { id: 2, level: 'B1', name: '–ü—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞', days: 150, res: 'Easy German Podcast', tasksA: [{id:'a3_1', title:'Intensive Reading', time:25, type:'Input'}, {id:'a3_2', title:'Anki: –ö–æ–ª–ª–æ–∫–∞—Ü–∏–∏', time:10, type:'Memory'}, {id:'a3_3', title:'Nebens√§tze: –ê–Ω–∞–ª–∏–∑', time:5, type:'Study'}], tasksB: [{id:'b3_1', title:'–ê—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏—è (Weil)', time:20, type:'Output'}, {id:'b3_2', title:'Shadowing: Podcast', time:15, type:'Output'}, {id:'b3_3', title:'Anki: –°–µ—Ç', time:5, type:'Memory'}] },
            { id: 3, level: 'B2', name: '–ò–º–º–µ—Ä—Å–∏—è', days: 120, res: '–†–æ–º–∞–Ω: Tschick', tasksA: [{id:'a4_1', title:'Tschick: –ß—Ç–µ–Ω–∏–µ', time:25, type:'Input'}, {id:'a4_2', title:'B2 Vocabulary Anki', time:10, type:'Memory'}, {id:'a4_3', title:'Passiv: –ê–Ω–∞–ª–∏–∑', time:5, type:'Study'}], tasksB: [{id:'b4_1', title:'–†–µ—Ü–µ–Ω–∑–∏—è –Ω–∞ –≥–ª–∞–≤—É', time:20, type:'Output'}, {id:'b4_2', title:'–î–µ–±–∞—Ç—ã (ChatGPT)', time:15, type:'Output'}, {id:'b4_3', title:'Anki: –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ', time:5, type:'Memory'}] },
            { id: 4, level: 'C1', name: '–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ', days: 97, res: 'Die Zeit', tasksA: [{id:'a5_1', title:'Die Zeit: –ê–Ω–∞–ª–∏–∑', time:25, type:'Input'}, {id:'a5_2', title:'–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π –≤–æ–∫–∞–±', time:10, type:'Memory'}, {id:'a5_3', title:'TestDaF: Leseverstehen', time:5, type:'Study'}], tasksB: [{id:'b5_1', title:'–ü–∏—Å—å–º–æ C1 (–¢–∞–π–º–µ—Ä)', time:25, type:'Output'}, {id:'b5_2', title:'–ú–æ–Ω–æ–ª–æ–≥ C1', time:10, type:'Output'}, {id:'b5_3', title:'Anki: –§–∏–Ω–∞–ª', time:5, type:'Memory'}] }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [error, setError] = useState(null);
            const [state, setState] = useState({ currentPhaseId: 0, completedTasks: [], streak: 0, startDate: new Date().toISOString(), lastActivity: new Date().toDateString(), autoAdvance: true });

            useEffect(() => {
                const init = setInterval(() => {
                    if (window.API) {
                        clearInterval(init);
                        window.API.onAuthStateChanged(window.API.auth, (u) => {
                            if (!u) window.API.signInAnonymously(window.API.auth);
                            setUser(u);
                        });
                    }
                }, 50);
                return () => clearInterval(init);
            }, []);

            useEffect(() => {
                if (!user || !window.API) return;
                const path = window.API.doc(window.API.db, "artifacts", "deutsch-pro-v1", "users", user.uid, "settings", "state");
                const unsub = window.API.onSnapshot(path, (snap) => {
                    if (snap.exists()) setState(prev => ({ ...prev, ...snap.data() }));
                });
                return () => unsub();
            }, [user]);

            const save = (ns) => {
                if (!user || user.isAnonymous || !window.API) return;
                const path = window.API.doc(window.API.db, "artifacts", "deutsch-pro-v1", "users", user.uid, "settings", "state");
                window.API.setDoc(path, ns);
            };

            const handleLogin = async () => {
                setError(null);
                try {
                    await window.API.signInWithPopup(window.API.auth, window.API.provider);
                } catch (e) {
                    console.error(e);
                    if (e.code === 'auth/unauthorized-domain') {
                        setError("–û—à–∏–±–∫–∞: –î–æ–º–µ–Ω –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å –≤ Firebase Console -> Authentication -> Settings -> Authorized domains.");
                    } else {
                        setError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                    }
                }
            };

            const handleLogout = async () => {
                if (confirm("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ Google? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—Ö–æ–¥–µ.")) {
                    await window.API.signOut(window.API.auth);
                    window.location.reload();
                }
            };

            const daysPassed = useMemo(() => {
                return Math.max(0, Math.floor((new Date() - new Date(state.startDate)) / 86400000));
            }, [state.startDate]);

            const isDayA = daysPassed % 2 === 0;
            const currentPhase = PHASES[state.currentPhaseId];
            const tasks = isDayA ? currentPhase.tasksA : currentPhase.tasksB;

            const toggleTask = (id) => {
                const isDone = state.completedTasks.includes(id);
                const nt = isDone ? state.completedTasks.filter(t => t !== id) : [...state.completedTasks, id];
                const today = new Date().toDateString();
                let ns = state.streak;
                if (!isDone && state.lastActivity !== today) ns += 1;
                const newState = { ...state, completedTasks: nt, lastActivity: today, streak: ns };
                setState(newState);
                save(newState);
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#F8FAFC] flex flex-col pb-28 shadow-xl">
                    <header className="bg-white p-5 flex justify-between items-center sticky top-0 z-50 border-b border-slate-100 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                                <span className="text-white font-black text-xl">D</span>
                            </div>
                            <div>
                                <h1 className="text-lg font-black tracking-tighter">MEISTER</h1>
                                <p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Day {daysPassed + 1}/547</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            {user && !user.isAnonymous ? (
                                <div className="flex items-center gap-2">
                                    <img src={user.photoURL} className="w-9 h-9 rounded-full border-2 border-indigo-100 shadow-sm" alt="User" />
                                    <button onClick={handleLogout} className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter hover:text-rose-500">–í—ã—Ö–æ–¥</button>
                                </div>
                            ) : (
                                <button 
                                    onClick={handleLogin}
                                    className="bg-indigo-600 text-white text-[10px] px-4 py-2 rounded-xl font-bold shadow-md hover:bg-indigo-700 btn-active"
                                >
                                    –í–û–ô–¢–ò
                                </button>
                            )}
                        </div>
                    </header>

                    {error && (
                        <div className="m-4 p-4 bg-rose-50 border border-rose-100 rounded-2xl text-[11px] text-rose-600 leading-relaxed animate-in">
                            {error}
                        </div>
                    )}

                    <main className="p-6 flex-grow overflow-y-auto no-scrollbar">
                        {view === 'home' && (
                            <div className="space-y-6 animate-in">
                                <div className="flex justify-between items-end">
                                    <div>
                                        <p className="text-[10px] font-black text-indigo-500 uppercase tracking-widest">{isDayA ? '–¶–∏–∫–ª A: –í–≤–æ–¥' : '–¶–∏–∫–ª B: –í—ã–≤–æ–¥'}</p>
                                        <h2 className="text-2xl font-black text-slate-800 leading-tight">–ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
                                    </div>
                                    <div className="flex flex-col items-end gap-1">
                                        <span className="text-[10px] font-black text-white bg-indigo-600 px-3 py-1 rounded-full uppercase">{currentPhase.level}</span>
                                        <span className="text-[10px] text-orange-500 font-black">üî• –°—Ç—Ä–∏–∫: {state.streak}</span>
                                    </div>
                                </div>

                                <div className="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                                    <div className="relative z-10 space-y-4">
                                        <h3 className="text-2xl font-black mb-6">40 –ú–∏–Ω—É—Ç <span className="text-indigo-400 uppercase">–§–æ–∫—É—Å–∞</span></h3>
                                        {tasks.map(t => (
                                            <div key={t.id} onClick={() => toggleTask(t.id)} className="flex items-center gap-4 bg-white/5 p-4 rounded-3xl border border-white/5 cursor-pointer hover:bg-white/10 transition-all btn-active">
                                                <div className={`w-8 h-8 rounded-xl border-2 flex items-center justify-center ${state.completedTasks.includes(t.id) ? 'bg-indigo-500 border-indigo-500 shadow-lg' : 'border-white/20'}`}>
                                                    {state.completedTasks.includes(t.id) && <span className="text-white text-xs">‚úì</span>}
                                                </div>
                                                <div className="flex-grow">
                                                    <p className={`font-bold text-sm ${state.completedTasks.includes(t.id) ? 'line-through opacity-40 text-slate-400' : ''}`}>{t.title}</p>
                                                    <p className="text-[9px] font-bold text-white/40 uppercase tracking-widest mt-1">{t.time} –ú–ò–ù ‚Ä¢ {t.type}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="absolute -bottom-10 -right-10 w-48 h-48 bg-indigo-500/20 blur-[80px] rounded-full"></div>
                                </div>
                            </div>
                        )}

                        {view === 'map' && (
                            <div className="space-y-4 animate-in">
                                <h2 className="text-2xl font-black mb-6 px-1">–î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞</h2>
                                {PHASES.map(p => (
                                    <div key={p.id} onClick={() => { if(confirm('–°–º–µ–Ω–∏—Ç—å —ç—Ç–∞–ø –≤—Ä—É—á–Ω—É—é?')) { const ns = {...state, currentPhaseId: p.id, completedTasks: []}; setState(ns); save(ns); setView('home'); } }} className={`p-6 rounded-[2rem] border-2 transition-all cursor-pointer relative ${state.currentPhaseId === p.id ? 'bg-indigo-600 text-white border-indigo-500 shadow-xl' : 'bg-white border-slate-100 opacity-60'}`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-[10px] font-black uppercase">{p.days} –¥–Ω–µ–π</span>
                                            <span className="font-black text-xl">{p.level}</span>
                                        </div>
                                        <h3 className="font-black text-lg">{p.name}</h3>
                                        <p className="text-[11px] opacity-80 mt-1">{p.res}</p>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'settings' && (
                          <div className="space-y-6 animate-in">
                              <h2 className="text-2xl font-black px-1">–û–ø—Ü–∏–∏</h2>
                              <div className="bg-white p-7 rounded-[2.5rem] border border-slate-100 shadow-sm space-y-4 text-center">
                                  <button onClick={() => window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=DeutschMeister%2040min&recur=RRULE:FREQ=DAILY`, '_blank')} className="w-full flex items-center justify-between p-4 bg-slate-900 rounded-2xl text-white font-bold text-[10px] uppercase tracking-widest transition-all btn-active">
                                      <span>Google Calendar Sync</span>
                                      <span>üìÖ</span>
                                  </button>
                                  <button onClick={() => { if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ –æ–±–Ω—É–ª–∏—Ç –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞.')) { const ns = { ...state, startDate: new Date().toISOString(), currentPhaseId: 0, streak: 0, completedTasks: [] }; setState(ns); save(ns); } }} className="w-full p-4 text-center text-rose-500 font-bold text-[10px] uppercase tracking-widest bg-rose-50 rounded-2xl border border-rose-100 btn-active">–°–±—Ä–æ—Å–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
                              </div>
                          </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 glass border-t border-slate-100 px-8 pb-10 pt-4 z-50 rounded-t-[2.5rem]">
                        <div className="max-w-md mx-auto flex justify-around">
                            <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 transition-all ${view === 'home' ? 'text-indigo-600 scale-110' : 'text-slate-400 opacity-50'}`}><span className="text-xl">‚ö°</span><span className="text-[8px] font-black uppercase">–ü–ª–∞–Ω</span></button>
                            <button onClick={() => setView('map')} className={`flex flex-col items-center gap-1 transition-all ${view === 'map' ? 'text-indigo-600 scale-110' : 'text-slate-400 opacity-50'}`}><span className="text-xl">üó∫Ô∏è</span><span className="text-[8px] font-black uppercase">–ö–∞—Ä—Ç–∞</span></button>
                            <button onClick={() => setView('settings')} className={`flex flex-col items-center gap-1 transition-all ${view === 'settings' ? 'text-indigo-600 scale-110' : 'text-slate-400 opacity-50'}`}><span className="text-xl">‚öôÔ∏è</span><span className="text-[8px] font-black uppercase">–û–ø—Ü–∏–∏</span></button>
                        </div>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

